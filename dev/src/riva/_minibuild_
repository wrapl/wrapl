GC_VERSION := "7.6.6"
var GC_DIR := file('gc-{GC_VERSION}')
var GC_LIB := file("libgc.a")

ATOMIC_OPS_VERSION := "7.6.4"
var ATOMIC_OPS_DIR := GC_DIR/"libatomic_ops"

CONFUSE_VERSION := "3.2"
CONFUSE_DIR := file('confuse-{CONFUSE_VERSION}')
CONFUSE_LIB := file("libconfuse.a")

CONFUSE_DIR => fun() do
	execute('wget -nv https://github.com/martinh/libconfuse/releases/download/v{CONFUSE_VERSION}/confuse-{CONFUSE_VERSION}.tar.gz -O- | tar xzP')
end

CONFUSE_LIB[CONFUSE_DIR] => fun() do
	execute("cd", CONFUSE_DIR, "&&",
		"./configure",
		"--prefix=/tmp",
		'--includedir={file("")}',
		'--libdir={file("")}',
		'CFLAGS=\"{CFLAGS}\"'
	)
	execute("cd", CONFUSE_DIR, "&&", "make")
	execute("cd", CONFUSE_DIR, "&&", "make install")
end

CFG_OPTS := {
	"--enable-munmap" is 4,
	"--enable-large-config",
	"--enable-shared" is :false,
	"--enable-static" is :true,
	"--enable-parallel-mark",
	"--disable-gcj-support",
	"--prefix" is "/tmp",
	"--includedir" is file(""),
	"--libdir" is file("")
}

if PLATFORM = "Linux" then
	CFG_OPTS := old + {"--enable-redirect-malloc"}
end

CFLAGS := old + ["-m32", "-DGC_THREADS", "-DTHREAD_LOCAL_ALLOC", "-DUSE_COMPILER_TLS", "-O2", '-I{file("")}']
LDFLAGS := old + ["-m32", "-pthread", "-ldl", "-lz", "-Wl,-E"]

GC_LIB[GC_DIR, ATOMIC_OPS_DIR] => fun() do
	execute("cd", GC_DIR, "&&",
		"./configure", CFG_OPTS, 'CFLAGS=\"{CFLAGS}\"'
	)
	execute("cd", GC_DIR, "&&", "make")
	execute("cd", GC_DIR, "&&", "make install")
end

GC_DIR => fun() do
	execute('wget -nv https://github.com/ivmai/bdwgc/releases/download/v{GC_VERSION}/gc-{GC_VERSION}.tar.gz -O- | tar xvzP')
end

ATOMIC_OPS_DIR[GC_DIR] => fun() do
	execute("mkdir", "-p", ATOMIC_OPS_DIR)
	execute("cd", ATOMIC_OPS_DIR, "&&",
		'wget -nv https://github.com/ivmai/libatomic_ops/releases/download/v{ATOMIC_OPS_VERSION}/libatomic_ops-{ATOMIC_OPS_VERSION}.tar.gz -O- | tar xvzP --strip-components=1'
	)
end

RIVA_FILES := [
	file("config.o"),
	file("debug.o"),
	file("directory.o"),
	file("fileset.o"),
	file("libriva.o"),
	file("log.o"),
	file("log2.o"),
	file("main.o"),
	file("memory.o"),
	file("module.o"),
	file("native.o"),
	file("path.o"),
	file("riva.o"),
	file("stringtable.o"),
	file("symbol.o"),
	file("dynamic.o"),
	file("relocate.o"),
	file("exception.o"),
	file("util.o")
]

for File in RIVA_FILES do
	File[GC_LIB, CONFUSE_LIB]
end

RIVA_CONF := OUT_BIN/"riva.conf"

RIVA_CONF => fun(FileName) do
	var File := open(FileName:string, "w")
	File:write(
'library = \{
	/lib,
	/usr/lib,
	/usr/lib32,
	/usr/lib/i386-linux-gnu,
	/usr/local/lib,
	{OUT_LIB}
}

parseargs = true

modules = \{
	Wrapl/Loader
}'
		)
	File:close
end

WRAPL_MODULES[RIVA_CONF]

c_program(RIVA, RIVA_FILES, [GC_LIB, CONFUSE_LIB])

DEFAULT[RIVA_CONF]