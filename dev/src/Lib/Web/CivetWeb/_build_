CIVETWEB_URL = "https://github.com/civetweb/civetweb/archive/v1.9.1.zip"
local CIVETWEB_ARCHIVE = file("civetweb-master.zip")
local CIVETWEB_DIR = file("civetweb-1.9.1")
local CIVETWEB_SRC = CIVETWEB_DIR/"src/civetweb.c"
local CIVETWEB_PATCHES = file("CivetWeb.patch")
local CIVETWEB_LIB = CIVETWEB_DIR/"libcivetweb.a"

YUAREL_URL = "https://github.com/jacketizer/libyuarel/archive/master.zip"
local YUAREL_ARCHIVE = file("yuarel-master.zip")
local YUAREL_DIR = file("libyuarel-master")
local YUAREL_LIB = YUAREL_DIR/"libyuarel.a"

CIVETWEB_LIB{CIVETWEB_DIR, CIVETWEB_PATCHED}:build(function()
	execute{"cd", CIVETWEB_DIR, "&&", "make clean"}
	execute{"cd", CIVETWEB_DIR, "&&", "make WITH_WEBSOCKET=1 lib"}
	execute{"cp", CIVETWEB_LIB, "."}
end)

CIVETWEB_ARCHIVE:build(function()
	execute{"wget -nv", CIVETWEB_URL, "-O", CIVETWEB_ARCHIVE}
end)

CIVETWEB_DIR{CIVETWEB_ARCHIVE, CIVETWEB_PATCHES}:build(function()
	execute{"unzip", "-o", CIVETWEB_ARCHIVE}
	execute{"patch", CIVETWEB_SRC, CIVETWEB_PATCHES}
end)

YUAREL_LIB{YUAREL_DIR}:build(function()
	execute{"cd", YUAREL_DIR, "&&", "make"}
	execute{"cp", YUAREL_LIB, "."}
end)

YUAREL_ARCHIVE:build(function()
	execute{"wget -nv", YUAREL_URL, "-O", YUAREL_ARCHIVE}
end)

YUAREL_DIR{YUAREL_ARCHIVE}:build(function()
	execute{"unzip", "-o", YUAREL_ARCHIVE}
end)

scope("civetweb", function()
	CFLAGS = extend(CFLAGS, "-I", CIVETWEB_DIR/"include", "-I", YUAREL_DIR)
	LDFLAGS = extend(LDFLAGS, "Riva/Memory.rlib", "IO/Stream.rlib", "Util/TypedFunction.rlib")
	file("CivetWeb.o"){CIVETWEB_LIB, YUAREL_LIB}
	riva_module("Web/CivetWeb", {file("CivetWeb.o")}, {CIVETWEB_LIB, YUAREL_LIB})
end)
