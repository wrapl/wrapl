FCGI_URL = "https://github.com/toshic/libfcgi/archive/master.zip"
local FCGI_ARCHIVE = file("master.zip")
local FCGI_DIR = file("libfcgi-master")

file("libfcgi.a"){FCGI_DIR}:build(function()
	execute{"cd", FCGI_DIR, "&&",
		"./configure --disable-shared --enable-static",
		"--prefix=" .. file(""),
		"--libdir=" .. file(""),
		"CFLAGS=\"" .. stringify(CFLAGS) .. " -O2\"",
		"--without-man-pages"
	}
	execute{"cd", FCGI_DIR, "&&",
		"make clean"
	}
	execute{"cd", FCGI_DIR, "&&",
		"make"
	}
	execute{"cd", FCGI_DIR, "&&",
		"make install"
	}
end)

FCGI_ARCHIVE:build(function()
	execute{"wget -nv", FCGI_URL}
end)

FCGI_DIR{FCGI_ARCHIVE}:build(function()
	execute{"unzip", "-o", FCGI_ARCHIVE}
	execute{"cd", FCGI_DIR, "&&",
		"patch -p0 <", file("fcgi.diff")
	}
end)

scope("fcgi", function()
	CFLAGS = extend(CFLAGS, "-I", file("include"))
	LDFLAGS = extend(LDFLAGS, "Riva/Memory.rlib", "IO/Stream.rlib", "Util/TypedFunction.rlib")
	file("Init.o"){file("libfcgi.a")}
	riva_module("Web/FastCGI", {file("Init.o")}, {file("libfcgi.a")})
end)