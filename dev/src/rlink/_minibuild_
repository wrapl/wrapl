UDIS_VERSION := "1.7.2"
UDIS_URL := 'http://downloads.sourceforge.net/project/udis86/udis86/1.7/udis86-{UDIS_VERSION}.tar.gz'
UDIS_DIR := file('udis86-{UDIS_VERSION}')

UDIS_LIB[UDIS_DIR] => fun() do
	execute("cd", UDIS_DIR, "&&",
		"./configure --disable-shared --enable-static",
		'--prefix={file("")}',
		'--includedir={file("")}',
		'--libdir={file("")}',
		"--without-man-pages",
		'CFLAGS=\"{LIBCFLAGS}\"',
		'LDFLAGS=\"{LIBLDFLAGS}\"'
	)
	execute("cd", UDIS_DIR, "&&",
		"make mostlyclean"
	)
	execute("cd", UDIS_DIR, "&&",
		"make TARGET_LIBS=\"static\""
	)
	execute("cd", UDIS_DIR, "&&",
		"make install"
	)
end

UDIS_DIR => fun() do
	execute("wget -nv", UDIS_URL, "-O- | tar xvzP")
end

LDFLAGS := old + ["-L.", "-lz", "-ldl", "-g", "-lgc"]
CFLAGS := old + ["-DUSE_UDIS", "-g", "-DLINUX", "-std=gnu99", "-DPACKAGE", "-DPACKAGE_VERSION"]

file("rlink.o")[UDIS_LIB]

var Minilang := file("minilang"):mkdir

var Objects := [
	file("rlink.o"),
	Minilang / "minilang.o",
	Minilang / "stringmap.o",
	Minilang / "sha256.o",
	Minilang / "linenoise.o"
]

if PLATFORM = "Linux" then
--	LDFLAGS := old + ["-lbfd"]
--	c_program(RLINK, Objects, [UDIS_LIB, GC_LIB])
	BINUTILS_VERSION := "2.30"
	BINUTILS_URL := 'https://ftp.gnu.org/gnu/binutils/binutils-{BINUTILS_VERSION}.tar.gz'
	BINUTILS_DIR := file('binutils-{BINUTILS_VERSION}')
	file("lib32/liberty.a")[BINUTILS_DIR] => fun() do
		execute("cd", BINUTILS_DIR / "libiberty", "&&",
			"./configure --build=i686-linux-gnu",
			"--enable-install-libiberty",
			'--prefix={file("")}',
			"--without-man-pages",
			'CFLAGS=\"{LIBCFLAGS}\"',
			'LDFLAGS=\"{LIBLDFLAGS}\"'
		)
		execute("cd", BINUTILS_DIR / "libiberty", "&& make")
		execute("cd", BINUTILS_DIR / "libiberty", "&& make install")
	end
	file("lib/libbfd.a")[BINUTILS_DIR] => fun() do
		execute("cd", BINUTILS_DIR, "&&",
			"./configure --build=i686-linux-gnu",
			'--prefix={file("")}',
			"--without-man-pages",
			'CFLAGS=\"{LIBCFLAGS}\"',
			'LDFLAGS=\"{LIBLDFLAGS}\"'
		)
		execute("cd", BINUTILS_DIR, "&& make")
		execute("cd", BINUTILS_DIR, "&& make install")
	end
	BINUTILS_DIR => fun() do
		execute("wget - nv", BINUTILS_URL, "-O- | tar xvzP")
	end
	CFLAGS := old + ['-I{file("include")}']
	c_program(RLINK, Objects, [UDIS_LIB, GC_LIB, file("lib/libbfd.a"), file("lib32/libiberty.a")])
elseif PLATFORM = "Darwin" then
	BINUTILS_VERSION := "2.30"
	BINUTILS_URL := 'https://ftp.gnu.org/gnu/binutils/binutils-{BINUTILS_VERSION}.tar.gz'
	BINUTILS_DIR := file('binutils-{BINUTILS_VERSION}')
	file("lib/libbfd.a")[BINUTILS_DIR] => fun() do
		execute("cd", BINUTILS_DIR, "&&",
			"./configure --build=i386-apple-darwin16.6.0",
			'--prefix={file("")}',
			"--without-man-pages",
			'CFLAGS=\"{LIBCFLAGS}\"',
			'LDFLAGS=\"{LIBLDFLAGS}\"'
		)
		execute("cd", BINUTILS_DIR, "&& make")
		execute("cd", BINUTILS_DIR, "&& make install")
	end
	BINUTILS_DIR => fun() do
		execute("wget - nv", BINUTILS_URL, "-O- | tar xvzP")
	end
	CFLAGS := old + ['-I{file("include")}']
	c_program(RLINK, Objects, [UDIS_LIB, GC_LIB, file("lib/libbfd.a")])
end

