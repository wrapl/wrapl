RABBITMQ_URL := "https://github.com/alanxz/rabbitmq-c/archive/v0.9.0.tar.gz"
RABBITMQ_DIR := file("rabbitmq")
RABBITMQ_LIB := file("lib/librabbitmq.a")

RABBITMQ_LIB[RABBITMQ_DIR] => fun() do
	var BuildDir := (RABBITMQ_DIR / "build"):rmdir:mkdir
	execute("cd", BuildDir, '&& CFLAGS=\"{CFLAGS}\" cmake -DCMAKE_INSTALL_PREFIX={BUILDDIR} BUILD_SHARED_LIBS=OFF BUILD_STATIC_LIBS=ON ..')
	execute("cd", BuildDir, '&& CFLAGS=\"{CFLAGS}\" cmake --build . --config Release --target install')
end

RABBITMQ_DIR => fun() do
	mkdir(RABBITMQ_DIR)
	execute("cd", RABBITMQ_DIR, "&&",
		"wget --user-agent=\"Firefox/3.6.12\" -nv", RABBITMQ_URL, "-O- | tar xvzP --strip-components=1"
	)
end

CFLAGS := old + ["-I", file("include")]
LDFLAGS := old + ["Riva/Memory.rlib"]
file("RabbitMQ.o")[RABBITMQ_LIB]
riva_module("Util/RabbitMQ", [file("RabbitMQ.o")])
